# Enhanced backfill workflow - fixed range function issue
main:
  params: [args]
  steps:
    - init_vars:
        assign:
          - success_count: 0
          - error_count: 0
          - apis: ["httpbin", "jsonplaceholder", "reqres", "cat-facts", "dog-api"]
          - iterations: 1
    
    - check_iterations:
        switch:
          - condition: ${args != null and "iterations" in args}
            assign:
              - iterations: ${args.iterations}
    
    - check_apis:
        switch:
          - condition: ${args != null and "apis" in args}
            assign:
              - apis: ${args.apis}
    
    - backfill_loop:
        for:
          value: iter
          range: ${[0, iterations - 1]}
          steps:
            - api_loop:
                for:
                  value: api_name
                  in: ${apis}
                  steps:
                    - call_api:
                        try:
                          call: http.get
                          args:
                            url: '${"https://api-ingest-424zvnon7q-ew.a.run.app/ingest/" + api_name}'
                            timeout: 60
                          result: api_result
                        except:
                          as: e
                          steps:
                            - increment_errors:
                                assign:
                                  - error_count: ${error_count + 1}
                                next: continue
                    
                    - increment_success:
                        assign:
                          - success_count: ${success_count + 1}
    
    - return_result:
        return:
          status: "completed"
          message: "Backfill process completed"
          iterations_completed: ${iterations}
          apis_processed: ${len(apis)}
          successful_calls: ${success_count}
          failed_calls: ${error_count} 
